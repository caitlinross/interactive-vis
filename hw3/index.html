<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>D3 Test</title>
        <style>
            body {
                font: 10px sans-serif;
                shape-rendering: crispEdges;
            }

            .hour {
                fill: #fff;
                stroke: #ccc;
            }

            .day {
                fill: #fff;
                stroke: #ccc;
            }

            .month {
                fill: none;
                stroke: #000;
                stroke-width: 2px;
            }

            .sched {
                font: 11px sans-serif;
            }

            .graphTitle {
                font: 22px sans-serif;
                text-align: center;
            }

            div.selectionmenu {
                position: relative;
                top: 400px;
                left: 50px;
                width: 500px;
                height: 50px;
                border: 3px solid #000000;
                font: 14px sans-serif;
            }

            div.scheds {
                position: absolute;
                top: 10px;
                left: 10px;
                width: 120px;
                height: 100px;
            }

            div.times {
                position: absolute;
                top: 10px;
                left: 350px;
                width: 150px;
                height: 100px;
            }

            div.metrics {
                position: absolute;
                top: 10px;
                left: 150px;
                width: 100px;
                height: 100px;
            }

            .RdYlGn .q0-11{fill:rgb(5,48,97)}
            .RdYlGn .q1-11{fill:rgb(33,102,172)}
            .RdYlGn .q2-11{fill:rgb(67,147,195)}
            .RdYlGn .q3-11{fill:rgb(146,197,222)}
            .RdYlGn .q4-11{fill:rgb(209,229,240)}
            .RdYlGn .q5-11{fill:rgb(247,247,247)}
            .RdYlGn .q6-11{fill:rgb(253,219,199)}
            .RdYlGn .q7-11{fill:rgb(244,165,130)}
            .RdYlGn .q8-11{fill:rgb(214,96,77)}
            .RdYlGn .q9-11{fill:rgb(178,24,43)}
            .RdYlGn .q10-11{fill:rgb(103,0,31)}
        </style>
        <script type="text/javascript" src="d3/d3.js"></script>
    </head>
    <body>
        <script type="text/javascript">
        // Adapted from http://bl.ocks.org/mbostock/4063318#index.html by Mike Bostock 

        // change size of cells and of area the cells are shown in
        var width = 1200,
            height = 150,
            cellSize = 20; 

        // format the percentages and data for the html tags
        var percent = d3.format(".1%"),
            format = d3.format("d");

        // get correct heat map color
        var color = d3.scale.quantize()
            .domain([0, 1])
            .range(d3.range(11).map(function(d) { return "q" + d + "-11"; }));

        var titlePar = d3.select("body")
            .append("p")
            .attr("class", "graphTitle")
            .text("Client Utilization rate per day for FCFS scheduling");

        // create the SVG
        var localsvg = d3.select("body").select("svg")
            .data(d3.range(1))
            .enter().append("svg")
            .attr("width", width)
            .attr("height", height)
            .attr("class", "RdYlGn")
            .append("g")
            .attr("transform", "translate(" + ((width - cellSize * 53) / 2) + "," + (height - cellSize * 7 - 1) + ")");
       
        var remotesvg = d3.select("body").select("svg")
            .data(d3.range(1))
            .enter().append("svg")
            .attr("width", width)
            .attr("height", height)
            .attr("class", "RdYlGn")
            .append("g")
            .attr("transform", "translate(" + ((width - cellSize * 53) / 2) + "," + (height - cellSize * 7 - 1) + ")");

        // create text for names of row sections 
        localsvg.append("text")
            .attr("transform", "translate(-6," + cellSize * 3.5 + ")rotate(-90)")
            .style("text-anchor", "middle")
            .text("WAN Site 1 (local)");

        remotesvg.append("text")
            .attr("transform", "translate(-6," + cellSize * 3.5 + ")rotate(-90)")
            .style("text-anchor", "middle")
            .text("WAN Site 2 (remote)");

        // create rectangles for days
        var rect1 = localsvg.selectAll(".day")
            .data(createDays()) 
            .enter().append("rect")
            .attr("class", "day")
            .attr("width", cellSize)
            .attr("height", cellSize)
            .attr("x", function(d) { return getWeekPos(d) * cellSize; })
            .attr("y", function(d) { return getDayPos(d) * cellSize; })
            .datum(format);

        var rect2 = remotesvg.selectAll(".day")
            .data(createDays()) 
            .enter().append("rect")
            .attr("class", "day")
            .attr("width", cellSize)
            .attr("height", cellSize)
            .attr("x", function(d) { return getWeekPos(d) * cellSize; })
            .attr("y", function(d) { return getDayPos(d) * cellSize; })
            .datum(format);

        var loadData = function() {
            var sched = document.getElementById('sched_policy').selectedOptions[0].text;
            var dataFile = sched + '.csv';
            var metric = document.getElementById('metric').selectedOptions[0].value;

            var pageTitle = ""
            if (metric == 0)
            { pageTitle += "Client Utilization Rate"; }
            else if (metric == 1)
            { pageTitle += "Job Response Time"; }
            if (metric == 2)
            { pageTitle += "Data Movement Overhead"; }
            pageTitle += " for " + sched + " scheduling";

            titlePar.text(pageTitle);

            // read in the data (in csv format)
            d3.csv(dataFile, function(error, csv) {
                if (error) throw error;

                var data = d3.nest()
                    .key(function(d) { return d.timestamp; })
                    .key(function(d) { 
                        if (d.site == "local") { return 0; }
                        else { return 1; } })
                    .rollup(function(d) { 
                        if (metric == 0) { return d[0].util; }
                        else if (metric == 1) { return d[0].resp; }
                        else { return d[0].dmo; } })
                    .map(csv);

                    rect1.filter(function(d) { return d in d3.keys(data); })
                    .attr("class", function(d) { return "day " + color(data[d][0]); })
                    .select("title")
                    .text(function(d) {  return d + ": " + (data[d]); });

                    rect2.filter(function(d) { return d in d3.keys(data); })
                    .attr("class", function(d) { return "day " + color(data[d][1]); })
                    .select("title")
                    .text(function(d) { return d + ": " + (data[d]); });
            });
        };

        function createDays() {
            var alldays = d3.range(20*7); 
            return alldays;
        }

        function getWeekPos(t) {
            return Math.floor(t/7);
        }

        function getDayPos(t) {
            return t % 7;
        }

        d3.select(self.frameElement).style("height", "2910px");
    </script>
    <div class="selectionmenu">
        <div class="scheds" id="schedselect">
            Scheduling policy:</br> 
            <select onchange="loadData()" id="sched_policy">
                <option>FCFS</option>
                <option>Best-Fit</option>
                <option>Greedy</option>
                <option>Proxy-Aware</option>
            </select>
        </div>
        <div class="times" id="timeselect">
            Time granularity:</br> 
            <select id="time_gran">
                <option value="0">Hours</option>
                <option value="1">Days</option>
                <option value="2">Weeks</option>
            </select>
        </div>
        <div class="metrics" id="metricselect">
            Metric:</br> 
            <select onchange="loadData()" id="metric">
                <option value="0">Client Utilization</option>
                <option value="1">Job Response Time</option>
                <option value="2">Data Movement Overhead</option>
            </select>
        </div>
    </div>
    </body>
</html>
